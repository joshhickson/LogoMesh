# GPU-Enabled Dockerfile for Lambda Cloud (H100/A100)
# Base: Nvidia CUDA 12.1 (Required for vLLM)
FROM nvidia/cuda:12.1.0-devel-ubuntu22.04

# Avoid interactive prompts during apt installs
ENV DEBIAN_FRONTEND=noninteractive

# 1. Install System Dependencies
# - software-properties-common: for add-apt-repository
# - curl, git: for tools
# - Python 3.12: via deadsnakes PPA (Ubuntu 22.04 ships with 3.10)
# - Node.js 20: via nodesource
RUN apt-get update && apt-get install -y \
    software-properties-common \
    curl \
    git \
    && add-apt-repository ppa:deadsnakes/ppa \
    && apt-get update && apt-get install -y \
    python3.12 \
    python3.12-venv \
    python3.12-dev \
    && curl -fsSL https://deb.nodesource.com/setup_20.x | bash - \
    && apt-get install -y nodejs \
    && rm -rf /var/lib/apt/lists/*

# Set Python 3.12 as default python3
RUN update-alternatives --install /usr/bin/python3 python3 /usr/bin/python3.12 1

# Install uv (The Python Package Manager)
RUN curl -LsSf https://astral.sh/uv/install.sh | env UV_INSTALL_DIR="/usr/local/bin" sh

# Install pnpm
RUN npm install -g pnpm

# 2. Setup Workspace
WORKDIR /app

# 3. Node.js Dependencies (Sidecars)
COPY package.json pnpm-lock.yaml pnpm-workspace.yaml ./
COPY packages/ packages/
RUN pnpm install --frozen-lockfile

# 4. Python Dependencies (Agents + vLLM)
COPY pyproject.toml uv.lock README.md ./
# Sync dependencies (This will install vllm because we are on Linux)
RUN uv sync

# 5. Copy Source Code
COPY src/ src/
COPY scenarios/ scenarios/
COPY main.py .

# 6. Runtime Configuration
# Ensure we use the virtual environment created by uv
ENV PATH="/app/.venv/bin:$PATH"

# Default Command
CMD ["python3", "main.py", "--help"]
