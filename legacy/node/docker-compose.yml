version: '3.8'

services:
  redis:
    build: ./docker-redis
    ports:
      - '6379:6379'
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 1s
      timeout: 3s
      retries: 30

  api-server:
    build: .
    command: pnpm --filter @logomesh/server start
    ports:
      - '3001:3001'
    depends_on:
      redis:
        condition: service_healthy
    environment:
      - NODE_ENV=test
      - REDIS_HOST=redis
      - REDIS_PORT=6379

  safe-workers:
    build: .
    command: >
      sh -c "pnpm --filter @logomesh/workers start:rationale &
             pnpm --filter @logomesh/workers start:architectural &
             wait"
    depends_on:
      redis:
        condition: service_healthy
    environment:
      - REDIS_HOST=redis
      - REDIS_PORT=6379

  testing-worker:
    build: .
    command: pnpm --filter @logomesh/workers start:testing
    depends_on:
      redis:
        condition: service_healthy
    environment:
      - REDIS_HOST=redis
      - REDIS_PORT=6379

  e2e-tester:
    build: .
    command: pnpm --filter @logomesh/server test
    depends_on:
      - api-server
      - safe-workers
      - testing-worker
    environment:
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - API_SERVER_URL=http://api-server:3001
