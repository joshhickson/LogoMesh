---
status: ACTIVE
type: Spec
created: 2026-01-09
updated: 2026-01-30
context: Green Agent Operations
---


# Persistence Architecture

> **Empirical Verification (2026-01-30):**
> This spec is empirically verified against the current codebase and review docs. All terminology, data flow, and implementation details are accurate as of this date. See:
> - [src/green_logic/agent.py](../../../src/green_logic/agent.py)
> - [file-reviews/green/agent.md](../file-reviews/green/agent.md)
> - [src/green_logic/server.py](../../../src/green_logic/server.py)

## Overview
The Green Agent uses a **hybrid persistence strategy** for auditability and durability. Results are stored both as cryptographic DBOM JSON artifacts and as rows in a crash-proof SQLite database.

## Storage Layer: SQLite + WAL
- **Database File:** `data/battles.db`
- **Journal Mode:** WAL (Write-Ahead Logging) is enabled for crash-proofing and concurrency.

### Schema: `battles` Table
| Column      | Type        | Description                                 |
|-------------|------------|---------------------------------------------|
| id          | INTEGER PK | Auto-incrementing primary key               |
| battle_id   | TEXT       | Unique session ID                           |
| timestamp   | TEXT       | ISO 8601 timestamp                          |
| score       | REAL       | Final CIS score                             |
| breakdown   | TEXT       | LLM explanation of the score                |
| raw_result  | TEXT       | Full JSON dump of the input/output          |
| dbom_hash   | TEXT       | SHA256 hash of the result (links to DBOM)   |

## Artifact Layer: DBOMs
- **Location:** `data/dboms/`
- **Format:** `dbom_<battle_id>.json`
- **Fields:**
	- `dbom_version`, `battle_id`, `h_delta` (SHA256), `v_intent` (intent vector), `score_cis`, `sigma_judge` (simulated signature), `timestamp`
- **Generated by:** `generate_dbom()` in [src/green_logic/agent.py](../../../src/green_logic/agent.py)

## Data Flow
1. **Evaluation:** The Green Agent calculates scores and evaluation results.
2. **Artifact Generation:** `generate_dbom()` creates the DBOM JSON file and computes the hash.
3. **Atomic Write:** `submit_result()` writes a row to `data/battles.db` (including the DBOM hash) and commits.

## Backup & Recovery
- **Database:** Back up both `battles.db` and `battles.db-wal` for integrity.
- **Artifacts:** Back up the entire `data/dboms/` directory for cryptographic auditability.

## Status (Empirically Verified)
- **Status:** Implemented and up-to-date.
- **Location:** [src/green_logic/agent.py](../../../src/green_logic/agent.py)
